<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>稲井中学校同窓会 - 参加人数</title>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-puUu4t3Tz0bXKpqHya5OKfUsfO6p5VIF7F/RCd5RnP1AIGfVU8F1RzotE6XzM2GkR+gGk/08yf1S1YWk+HCJ3Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Google Fonts - Noto Sans Japanese -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #3b82f6;
      --accent: #60a5fa;
      --light: #f0f9ff;
      --dark: #1e3a8a;
      --text: #1e293b;
      --text-light: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --shadow: rgba(0, 0, 0, 0.08);
    }

    /* 全体設定 */
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f8fafc;
      color: var(--text);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      line-height: 1.6;
    }

    /* コンテナ設定 */
    .container {
      max-width: 680px;
      width: 90%;
      background: #ffffff;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 30px var(--shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(to right, var(--primary), var(--accent));
    }

    /* ヘッダー設定 */
    .header {
      margin-bottom: 40px;
      position: relative;
    }

    .container h1 {
      font-size: 2.2rem;
      color: var(--dark);
      margin-bottom: 12px;
      font-weight: 700;
      letter-spacing: 0.03em;
      position: relative;
      display: inline-block;
    }

    .container h1::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: var(--primary);
      border-radius: 2px;
    }

    .subtitle {
      color: var(--text-light);
      font-weight: 300;
      font-size: 1.1rem;
      margin-top: 15px;
    }

    /* カード設定 */
    .stats-card {
      background: var(--light);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    /* データ表示用 */
    .count-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .count {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 15px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      transition: transform 0.3s ease;
    }

    .count:hover {
      transform: translateY(-3px);
    }

    .count-label {
      font-size: 1rem;
      color: var(--text-light);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }

    .count-label i {
      margin-right: 8px;
      color: var(--primary);
      font-size: 1.2rem;
    }

    .count-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .remaining-count {
      grid-column: span 2;
      background: var(--primary);
      color: white;
    }

    .remaining-count .count-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .remaining-count .count-label i {
      color: white;
    }

    .remaining-count .count-value {
      color: white;
      font-size: 2.2rem;
    }

    /* 情報表示 */
    .info-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* 更新タイム */
    .update-time {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .time-value {
      font-weight: 500;
      color: var(--text);
    }

    /* カウントダウン */
    #countdown {
      font-weight: 700;
      color: var(--warning);
    }

    /* リンクボタン */
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 30px;
    }

    .attendance-btn {
      display: inline-block;
      padding: 14px 24px;
      background: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .attendance-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(37, 99, 235, 0.25);
    }

    .attendance-btn.secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
      box-shadow: none;
    }

    .attendance-btn.secondary:hover {
      background: var(--light);
      color: var(--primary-dark);
    }

    /* メディアクエリ（レスポンシブ対応） */
    @media (max-width: 768px) {
      .container {
        padding: 30px 20px;
        width: 95%;
      }
      .container h1 {
        font-size: 1.8rem;
      }
      .count-container {
        grid-template-columns: 1fr;
      }
      .remaining-count {
        grid-column: span 1;
      }
    }

    /* ローディングスピナー */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(37, 99, 235, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .footer {
      margin-top: 40px;
      font-size: 0.85rem;
      color: var(--text-light);
    }
  </style>
</head>
<body>
  <!-- ローディング表示（Firebase 読み込み中） -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <div class="container" style="display: none;" id="main-container">
    <div class="header">
      <h1>稲井中学校同窓会</h1>
      <div class="subtitle">参加状況リアルタイム表示</div>
    </div>

    <div class="stats-card">
      <div class="count-container">
        <!-- 男性数 -->
        <div class="count">
          <div class="count-label"><i class="fa-solid fa-mars"></i> 男性</div>
          <div class="count-value" id="male-count">0</div>
        </div>
        
        <!-- 女性数 -->
        <div class="count">
          <div class="count-label"><i class="fa-solid fa-venus"></i> 女性</div>
          <div class="count-value" id="female-count">0</div>
        </div>
        
        <!-- 開催決定まであと何人 -->
        <div class="count remaining-count">
          <div class="count-label"><i class="fa-solid fa-hourglass-half"></i> 開催決定まであと</div>
          <div class="count-value" id="remaining-count">20</div>
        </div>
      </div>
      
      <!-- 回答者数 -->
      <div class="count">
        <div class="count-label"><i class="fa-solid fa-users"></i> 回答者数</div>
        <div class="count-value" id="response-count">0</div>
      </div>
    </div>

    <div class="info-section">
      <!-- 更新日時 -->
      <div class="update-time">
        回答状況更新: <span class="time-value" id="update-time">-</span>
      </div>
      <!-- 回答期日カウントダウン -->
      <div class="update-time">
        回答締切まで: <span id="countdown">-</span>
      </div>
    </div>

    <!-- リンクボタン -->
    <div class="buttons">
      <a href="https://inai95.web.app/attendance-form.html" class="attendance-btn">
        <i class="fa-solid fa-clipboard-check"></i> 出欠回答する
      </a>
      <a href="https://inai95.web.app/questionnaire.html" class="attendance-btn secondary">
        <i class="fa-solid fa-calendar-xmark"></i> 期日までに出欠回答できない方
      </a>
    </div>

    <div class="footer">
      © 2025 稲井中学校同窓会実行委員会
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase の構成情報
    const firebaseConfig = {
      apiKey: "AIzaSyD30sxoHhSnpH7xMwGj55SSjRkMRa0oRX8",
      authDomain: "inai95.firebaseapp.com",
      projectId: "inai95",
      storageBucket: "inai95.firebasestorage.app",
      messagingSenderId: "418002209728",
      appId: "1:418002209728:web:dc034e538d3bf0fae15625",
      measurementId: "G-58LP3ZDTLJ"
    };

    // Firebase 初期化
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 要素を取得
    const maleCountElement = document.getElementById('male-count');
    const femaleCountElement = document.getElementById('female-count');
    const remainingCountElement = document.getElementById('remaining-count');
    const updateTimeElement = document.getElementById('update-time');
    const responseCountElement = document.getElementById('response-count');
    const countdownElement = document.getElementById('countdown');

    const loadingElement = document.getElementById('loading');
    const mainContainer = document.getElementById('main-container');

    function updateCounts() {
      const now = new Date();
      const formattedTime = `${now.getMonth() + 1}月${now.getDate()}日 ${now.getHours()}時${now.getMinutes()}分`;
      updateTimeElement.textContent = formattedTime;

      // コレクション全体を取得して、回答者数 (snapshot.size) を計算し、
      // その中で出席の男性・女性を集計
      db.collection('attendance_responses').get()
        .then(snapshot => {
          // 回答者数
          const totalResponses = snapshot.size;
          responseCountElement.textContent = totalResponses;

          // 出席者の男性・女性カウント
          let maleCount = 0;
          let femaleCount = 0;

          snapshot.forEach(doc => {
            const data = doc.data();
            // attendance が '出席' の人だけ男女カウント
            if (data.attendance === '出席') {
              if (data.gender === '男性') maleCount++;
              if (data.gender === '女性') femaleCount++;
            }
          });

          maleCountElement.textContent = maleCount;
          femaleCountElement.textContent = femaleCount;

          // 開催決定の残り人数を表示（例: 20名到達で開催とする）
          const totalCount = maleCount + femaleCount;
          remainingCountElement.textContent = Math.max(20 - totalCount, 0);

          // 読み込み完了：ローディングを非表示にしてメインコンテナを表示
          loadingElement.style.display = 'none';
          mainContainer.style.display = 'block';
        })
        .catch(error => {
          console.error("データ取得エラー:", error);
          alert("データの取得に失敗しました。");
          loadingElement.style.display = 'none';
        });
    }

    // 回答期日カウントダウンの更新処理
    function updateCountdown() {
      const now = new Date();
      // 締切日時を2025年3月31日23時59分59秒に固定（JSでは月が0-indexedなので、3月は2）
      const deadline = new Date(2025, 2, 31, 23, 59, 59);
      const diff = deadline - now;

      if(diff <= 0) {
        countdownElement.textContent = "回答期日終了";
        return;
      }
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      countdownElement.textContent = days + "日 " + hours + "時 " + minutes + "分 " + seconds + "秒";
    }

    // 初回カウントダウン更新と1秒ごとの更新設定
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // 匿名認証後にデータ取得
    firebase.auth().signInAnonymously()
      .then(() => {
        console.log("匿名認証に成功しました");
        updateCounts();
      })
      .catch(error => {
        console.error("認証エラー:", error.message);
        alert("認証に失敗しました。リロードして再試行してください。");
        loadingElement.style.display = 'none';
      });
  </script>
</body>
</html>
